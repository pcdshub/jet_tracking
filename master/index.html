

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LCLS Jet Tracking Application &mdash; PCDS Jet Tracking 0.1.1.dev210+g0d9b0d5 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=03e43079" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=e59714d7" />

  
      <script src="_static/jquery.js?v=5d32c60e"></script>
      <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="_static/documentation_options.js?v=df59cc64"></script>
      <script src="_static/doctools.js?v=9a2dae69"></script>
      <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="_static/docs-versions-menu.js?v=3d6a1aea"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Installation" href="installation.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="#" class="icon icon-home">
            PCDS Jet Tracking
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Setup</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Control</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="control.html">Jet Control Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="shared_memory.html">Jet Tracking Shared Memory Application</a></li>
<li class="toctree-l1"><a class="reference internal" href="pvNotepad.html">Epics pvNotepad configuration</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Presentations and Posters</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="presentations.html">Presentations and Posters</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contributing</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">How to Contribute</a></li>
<li class="toctree-l1"><a class="reference internal" href="authors.html">Credits</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="#">PCDS Jet Tracking</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="#" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">LCLS Jet Tracking Application</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/index.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="lcls-jet-tracking-application">
<h1>LCLS Jet Tracking Application<a class="headerlink" href="#lcls-jet-tracking-application" title="Link to this heading"></a></h1>
<a class="reference external image-reference" href="https://travis-ci.org/pcdshub/jet_tracking"><img alt="https://img.shields.io/travis/pcdshub/jet_tracking.svg" src="https://img.shields.io/travis/pcdshub/jet_tracking.svg" />
</a>
<a class="reference external image-reference" href="https://pypi.python.org/pypi/jet_tracking"><img alt="https://img.shields.io/pypi/v/jet_tracking.svg" src="https://img.shields.io/pypi/v/jet_tracking.svg" />
</a>
<p>The purpose of this application is to automate the positioning of the liquid jet to be conincident with the x-rays.  This version is a start and mostly a proof of concept, because everyone knows you don’t build something right the first time ever.  Once this is fully functional then it can be rebuilt with a better architecture and file structure using the proven pieces.</p>
<section id="calibration">
<h2>Calibration<a class="headerlink" href="#calibration" title="Link to this heading"></a></h2>
<p>The calibration piece is used to identify the typical diffraction ring intensity from the solvent/substrate present in the liquid jet.  The current procedure is to take about 10 seconds of data in a recorded run then analyze the following:</p>
<ul class="simple">
<li><p>Making a cut on the distribution of incoming x ray intensity to identify events with good x ray intensity</p></li>
<li><p>Get the azimuthal average of the area detector for all of those events and identifying the peak intensity (brightest bin of the ring).  Then summing the intensities of the peak bin and a +/- delta bin value.</p></li>
<li><p>Get the projection of the jet camera and identify the peak intensity and location of that jet.</p></li>
</ul>
<section id="how-to-run-the-calibration">
<h3>How to run the calibration<a class="headerlink" href="#how-to-run-the-calibration" title="Link to this heading"></a></h3>
<p>There are two ways to run the calibration.<span class="raw-html-m2r"><br></span>
The suggested/production way is to run through Automatic Run Processing on pswww.
There is a current definition and run setup for xcsx39718 on Run 82.  You can see the results in the summaries tab for that experiment (elog (aka Data Manager) on pswww)</p>
<p>All of the meta data information is then saved in a json file with the path:
/cds/data/psdm/<span class="raw-html-m2r"><hutch></span>/<span class="raw-html-m2r"><experiment></span>/calib/jt_results</p>
<p>The second way to run the calibration is to do it locally, this is much easier for development.  In order to simplify and organize meta data as input parameters for the calibration we use config files located at /jet_tracking/jt_configs.  You need to change information there is you want to adjust certain calibration parameters.  to run you must be on a psana node</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ssh psana
$ cd &lt;base_path&gt;/jet_tracking/jet_tracking/jet_tracking_cal
$ source /reg/g/psdm/etc/psconda.sh -py3
$ python jt_cal.py --cfg &lt;path_to_config_file&gt;  # The default is xcs_config.yml so no arg required if using that one
</pre></div>
</div>
<p>Sample Output</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(ana-4.0.20-py3) aegger@psanagpu112:/cds/group/pcds/epics-dev/aegger/jet_tracking/jet_tracking/jet_tracking_cal$ python jt_cal.py
Will save small data to /reg/d/psdm/xcs/xcsx39718/scratch/run10_jt_cal.h5
Gathering small data for exp: xcsx39718, run: 10, events: 500
Detectors Available: [(&#39;XcsEndstation.1:ControlsCamera.16&#39;, &#39;xcs_yag4&#39;, &#39;&#39;), (&#39;EBeam&#39;, &#39;&#39;, &#39;&#39;), (&#39;FEEGasDetEnergy&#39;, &#39;&#39;, &#39;&#39;), (&#39;XCS-IPM-01&#39;, &#39;&#39;, &#39;&#39;), (&#39;XCS-IPM-03&#39;, &#39;&#39;, &#39;&#39;), (&#39;XCS-DIO-03&#39;, &#39;&#39;, &#39;&#39;), (&#39;HX2-SB1-BMMON&#39;, &#39;&#39;, &#39;&#39;), (&#39;XCS-SB1-BMMON&#39;, &#39;&#39;, &#39;&#39;), (&#39;XCS-SB2-BMMON&#39;, &#39;&#39;, &#39;&#39;), (&#39;XcsEndstation.0:Epix10ka.1&#39;, &#39;epix10k135&#39;, &#39;&#39;), (&#39;NoDetector.0:Evr.0&#39;, &#39;evr0&#39;, &#39;&#39;), (&#39;XcsEndstation.0:Epix10ka2M.0&#39;, &#39;epix10k2M&#39;, &#39;&#39;), (&#39;XcsEndstation.1:Opal1000.1&#39;, &#39;opal_1&#39;, &#39;&#39;), (&#39;ControlData&#39;, &#39;&#39;, &#39;&#39;)]
Unable to process event 0: &#39;NoneType&#39; object has no attribute &#39;TotalIntensity&#39;
Saved Small Data, Processing...
Results: {&#39;i0_low&#39;: 53345.170000000006, &#39;i0_high&#39;: 93364.9225, &#39;i0_median&#39;: 74307.8975, &#39;peak_bin&#39;: 12, &#39;delta_bin&#39;: 3, &#39;mean_ratio&#39;: 0.1453248744739173, &#39;med_ratio&#39;: 0.1463255684260074, &#39;std_ratio&#39;: 0.03161866013604559, &#39;jet_location_mean&#39;: 0.0, &#39;jet_location_std&#39;: 0.0, &#39;jet_peak_mean&#39;: 30354.924, &#39;jet_peak_std&#39;: 326.71924}
Creating Path /reg/d/psdm/xcs/xcsx39718/stats/summary/jt_cal_run_10
Saving report to /reg/d/psdm/xcs/xcsx39718/stats/summary/jt_cal_run_10/report.html
finished with jet tracking calibration
Closing remaining open files:run10_jt_cal.h5...done
</pre></div>
</div>
</section>
</section>
<section id="running-the-shared-memory-process">
<h2>Running the shared memory process<a class="headerlink" href="#running-the-shared-memory-process" title="Link to this heading"></a></h2>
<p>Once we have the needed calibration data, you can run the shared memory process</p>
<section id="sim-mode">
<h3>Sim Mode<a class="headerlink" href="#sim-mode" title="Link to this heading"></a></h3>
<p>If you set the sim variable to true in the config file, you will run in sim mode.  This means you will read offline data.  This is only setup to use one worker and a master so it’s somewhat slow, but very good for debugging.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ssh psana
$ cd &lt;base_path&gt;/jet_tracking/jet_tracking/mpi_scripts
$ ./run_mpi_script
</pre></div>
</div>
</section>
<section id="shared-memory">
<h3>Shared Memory<a class="headerlink" href="#shared-memory" title="Link to this heading"></a></h3>
<p>To run in shared memory you need to ssh to the mon node that has shared memory running.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ssh daq-cxi-mon01
$ cd &lt;base_path&gt;/jet_tracking/jet_tracking/mpi_scripts
$ ./run_mpi_script -p 8  # -p tells number of cores to use 1 Master, the reset workers
</pre></div>
</div>
</section>
</section>
<section id="table-of-contents">
<h2>Table of Contents<a class="headerlink" href="#table-of-contents" title="Link to this heading"></a></h2>
<div class="toctree-wrapper compound">
<p class="caption" role="heading"><span class="caption-text">Setup</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
</ul>
</div>
<div class="toctree-wrapper compound">
<p class="caption" role="heading"><span class="caption-text">Control</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="control.html">Jet Control Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="shared_memory.html">Jet Tracking Shared Memory Application</a><ul>
<li class="toctree-l2"><a class="reference internal" href="shared_memory.html#sc1-experiments">SC1 Experiments</a></li>
<li class="toctree-l2"><a class="reference internal" href="shared_memory.html#sc2-experiments">SC2 Experiments</a></li>
<li class="toctree-l2"><a class="reference internal" href="shared_memory.html#sc3-experiments">SC3 Experiments</a></li>
<li class="toctree-l2"><a class="reference internal" href="shared_memory.html#api">API</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="pvNotepad.html">Epics pvNotepad configuration</a></li>
</ul>
</div>
<div class="toctree-wrapper compound">
<p class="caption" role="heading"><span class="caption-text">Presentations and Posters</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="presentations.html">Presentations and Posters</a><ul>
<li class="toctree-l2"><a class="reference internal" href="presentations.html#summer-student-posters">2018 Summer Student Posters</a></li>
</ul>
</li>
</ul>
</div>
<div class="toctree-wrapper compound">
<p class="caption" role="heading"><span class="caption-text">Contributing</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">How to Contribute</a><ul>
<li class="toctree-l2"><a class="reference internal" href="contributing.html#types-of-contributions">Types of Contributions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="contributing.html#report-bugs">Report Bugs</a></li>
<li class="toctree-l3"><a class="reference internal" href="contributing.html#fix-bugs">Fix Bugs</a></li>
<li class="toctree-l3"><a class="reference internal" href="contributing.html#implement-features">Implement Features</a></li>
<li class="toctree-l3"><a class="reference internal" href="contributing.html#write-documentation">Write Documentation</a></li>
<li class="toctree-l3"><a class="reference internal" href="contributing.html#submit-feedback">Submit Feedback</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="contributing.html#get-started">Get Started!</a></li>
<li class="toctree-l2"><a class="reference internal" href="contributing.html#pull-request-guidelines">Pull Request Guidelines</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="authors.html">Credits</a><ul>
<li class="toctree-l2"><a class="reference internal" href="authors.html#contributors">Contributors</a></li>
</ul>
</li>
</ul>
</div>
</section>
</section>
<section id="indices-and-tables">
<h1>Indices and tables<a class="headerlink" href="#indices-and-tables" title="Link to this heading"></a></h1>
<ul class="simple">
<li><p><a class="reference internal" href="genindex.html"><span class="std std-ref">Index</span></a></p></li>
<li><p><a class="reference internal" href="py-modindex.html"><span class="std std-ref">Module Index</span></a></p></li>
<li><p><a class="reference internal" href="search.html"><span class="std std-ref">Search Page</span></a></p></li>
</ul>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="installation.html" class="btn btn-neutral float-right" title="Installation" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, SLAC National Accelerator Laboratory.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>